(function(){"use strict";const K=e=>Array.isArray(e)?e:[],$=e=>K(e).map(t=>{if(!t)return null;if(typeof t=="string")return{code:t,name:t,group:null};const r=t.code||t.id||t.value||t.slug||t.name,n=t.name||t.label||t.code,o=t.group||t.continent||t.region||t.category,s=typeof o=="string"&&o.trim()?o.trim():null;return r?{code:r,name:n||r,group:s}:null}).filter(t=>t&&t.code),b=e=>typeof e=="string"?e.trim():"",w=e=>{const t=b(e);return t?t.toLowerCase():""},M=()=>{const e=[],t=new Set;return{add(r){$(r).forEach(n=>{if(!n||!n.code)return;const o=b(n.code),s=w(o);!o||!s||t.has(s)||(t.add(s),e.push({code:o,name:n.name&&n.name!==o?n.name:o,group:typeof n.group=="string"&&n.group.trim()?n.group.trim():null}))})},list(){return e.slice()}}},F=()=>{var e,t,r,n;return $((n=(r=(t=(e=window.panel)==null?void 0:e.$store)==null?void 0:t.state)==null?void 0:r.languages)==null?void 0:n.all)},A=()=>F().map(e=>e.code).filter(Boolean),_=new Map,z=(e={},t={})=>{const r=["catalog","catalogLocales","localeCatalog","fallbackLocales","defaultLocales","builtinLocales"],n=l=>{for(const c of r)if(Object.prototype.hasOwnProperty.call(l,c))return l[c]},o=n(e);if(o!==void 0)return o;const s=n(t);if(s!==void 0)return s},k=async e=>{var c,d,i;if(_.has(e))return _.get(e);const t=M(),r=((c=window.panel)==null?void 0:c.config)||{},n=e.replace("/","."),o=(r==null?void 0:r[e])||(r==null?void 0:r[n])||{};let s=!1;if((i=(d=window.panel)==null?void 0:d.api)!=null&&i.get)try{const u=await window.panel.api.get(`${e}/locales`),p=$((u==null?void 0:u.data)||u);p.length&&(t.add(p),s=!0)}catch(u){(u==null?void 0:u.status)!==404&&console.warn(`[${e}] Unable to fetch locales via plugin endpoint.`,u)}if(s===!1){t.add(F());const u=z(o,{...r,[e]:r==null?void 0:r[e],[n]:r==null?void 0:r[n]});u&&u!==!0&&t.add(u)}const l=t.list();return l.length===0&&console.warn(`[${e}] No locales available. Configure \`grommasdietz.kirby-locale.locales\` or enable the plugin API route.`),_.set(e,l),l},O=(e=[],t=null,r=[])=>{const n=[],o=new Set,s=new Set(r.map(a=>w(a)).filter(Boolean)),l=a=>typeof a=="string"&&a.trim()?w(a):"",c=a=>{const m=a==null?void 0:a.group;return typeof m=="string"&&m.trim()?m.trim():""},d=a=>{if(!a||!a.code)return;const m=b(a.code),y=w(m);!m||!y||o.has(y)||(o.add(y),n.push({value:a.code,text:a.name&&a.name!==a.code?`${a.name} (${a.code})`:a.code}))};let i=null;const u=(a,m=!1)=>{m&&(i=null),a.forEach(y=>{const L=c(y),C=L?l(L):"";L&&C!==i&&(n.push({value:`__group__${C||n.length}`,text:L,disabled:!0}),i=C),L||(i=null),d(y)})},p=e.filter(a=>s.has(w(a.code))),f=e.filter(a=>s.has(w(a.code))===!1);u(p,!0),p.length&&f.length&&(n.push({value:"__separator__",text:"──────────",disabled:!0}),i=null),u(f,!0);const g=b(t);if(g&&g!=="__separator__"){const a=w(g);a&&o.has(a)===!1&&(n.unshift({value:t,text:t}),o.add(a))}return n},v=(e,t,r)=>{var o;const n=`${e.replace("/",".")}.${t}`;if(typeof((o=window.panel)==null?void 0:o.$t)=="function"){const s=window.panel.$t(n);if(s!==n)return s}return r??n},B=(e,t,r)=>{const n=A(),o=O(r,t,n),s=o.filter(i=>i.disabled!==!0),l=s.length>0,c={label:v(e,"locale.dialog.selectLabel","Locale"),autofocus:!0},d=l?{...c,type:"select",empty:{text:v(e,"locale.dialog.empty","No locale")},options:o,searchable:s.length>7}:{...c,type:"text",placeholder:v(e,"locale.prompt","Enter the locale code (e.g. de, en-GB)")};return{component:"k-form-dialog",props:{icon:"translate",size:"medium",headline:v(e,"locale.dialog.headline","Choose locale for selection"),cancelButton:!0,submitButton:!0,fields:{locale:d},value:{locale:t}}}},D=({pluginId:e,value:t="",locales:r=[]})=>{var o,s;if(!((s=(o=window.panel)==null?void 0:o.dialog)!=null&&s.open))return console.warn(`[${e}] Kirby Panel dialog API is not available. Cannot open locale dialog.`),Promise.resolve(null);const n=B(e,t,r);return new Promise(l=>{let c=!1;const d=p=>{var f,g;c||(c=!0,typeof((g=(f=window.panel)==null?void 0:f.dialog)==null?void 0:g.close)=="function"&&window.panel.dialog.close(),l(p))},i=p=>{const f=p==null?void 0:p.locale;if(typeof f!="string"){d(null);return}const g=f.trim();if(!g||g==="__separator__"){d(null);return}d(g)},u=()=>{d(!1)};try{const p=window.panel.dialog.open(n,{on:{submit:i,cancel:u,close:u}});typeof(p==null?void 0:p.catch)=="function"&&p.catch(f=>{console.error(`[${e}] Failed to open locale dialog.`,f),u()})}catch(p){console.error(`[${e}] Failed to open locale dialog.`,p),u()}})},E=e=>({get button(){return{icon:"translate",label:window.panel.$t(`${e.replace("/",".")}.locale.label`)}},commands(){return async()=>{const t=this.editor.getMarkAttrs("locale")||{},r=typeof t.lang=="string"?t.lang:"",n=await k(e),o=await D({pluginId:e,value:r,locales:n});if(o!==!1){if(!o){this.remove();return}this.update({lang:o})}}},get name(){return"locale"},get schema(){return{attrs:{lang:{default:null}},parseDOM:[{tag:"span.notranslate[lang]",getAttrs:t=>({lang:t.getAttribute("lang")})}],toDOM:t=>["span",{class:"notranslate",lang:t.attrs.lang||null},0]}}}),h="grommasdietz/kirby-locale",P=(e,t=null,r=null)=>{const n=A(),o=O(e,t,n),s=o.filter(d=>d.disabled!==!0),l=r?{...r}:{};let c=typeof t=="string"&&t.trim()!==""?t:null;if(!c&&s.length>0){const d=s.find(i=>typeof i.value=="string"&&n.includes(i.value));if(d)c=d.value;else{const i=s[0].value;c=typeof i=="string"&&i!==""?i:null}}return{field:{...l,name:"titleLocale",label:window.panel.$t("grommasdietz.kirby-locale.label"),type:"select",options:o,empty:{text:window.panel.$t("grommasdietz.kirby-locale.dialog.empty")},search:s.length>7,icon:"translate",width:"1/3",value:c},value:c}},S=(e,t,r)=>{var l,c;if(!((c=(l=e==null?void 0:e.props)==null?void 0:l.fields)!=null&&c.titleLocale))return e;const n=e.props.fields??{},o={...n.titleLocale||{},...t},s=n.title?{...n.title,width:"2/3"}:n.title;return{...e,props:{...e.props,fields:{...n,...s?{title:s}:{},titleLocale:o},value:{...e.props.value,titleLocale:r??null}}}},j=async(e,t)=>{var r,n;if(!e||!((n=(r=window.panel)==null?void 0:r.api)!=null&&n.get))return null;try{const o=await window.panel.api.get(`${h}/title-locale`,{id:e,language:t}),s=(o==null?void 0:o.data)||o,l=s==null?void 0:s.titleLocale;if(typeof l=="string"&&l.trim())return l}catch(o){console.warn(`[${h}] Unable to load stored title locale.`,o)}return null},G=(e={})=>{var r,n,o,s;if(typeof e.language=="string"&&e.language)return e.language;const t=(s=(o=(n=(r=window.panel)==null?void 0:r.$store)==null?void 0:n.state)==null?void 0:o.languages)==null?void 0:s.current;return typeof t=="string"&&t?t:null},N=(e={})=>{var t,r;return(t=e==null?void 0:e.page)!=null&&t.id?e.page.id:(r=e==null?void 0:e.model)!=null&&r.id?e.model.id:e!=null&&e.id?e.id:null};window.panel.plugin(h,{writerMarks:{locale:E(h)},dialogs:{async"page.create"(e){var l,c,d,i;const t=await k(h),r=((c=(l=e==null?void 0:e.props)==null?void 0:l.value)==null?void 0:c.titleLocale)??null,n=((i=(d=e==null?void 0:e.props)==null?void 0:d.fields)==null?void 0:i.titleLocale)??null;if(!n)return e;const{field:o,value:s}=P(t,r,n);return S(e,o,s)},async"page.changeTitle"(e,t={}){var i,u,p,f;const r=N(t),n=G(t),o=await k(h),s=((u=(i=e==null?void 0:e.props)==null?void 0:i.fields)==null?void 0:u.titleLocale)??null;if(!s)return e;let l=((f=(p=e==null?void 0:e.props)==null?void 0:p.value)==null?void 0:f.titleLocale)??null;l||(l=await j(r,n));const{field:c,value:d}=P(o,l,s);return S(e,c,d)}}})})();
